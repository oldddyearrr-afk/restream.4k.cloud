worker_processes 1;
error_log /app/stream/logs/nginx_error.log warn;
pid /app/stream/logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    types {
        text/html                             html htm;
        text/css                              css;
        application/javascript                js;
        application/vnd.apple.mpegurl         m3u8;
        video/mp2t                            ts;
        application/octet-stream              bin;
    }
    default_type application/octet-stream;

    access_log /app/stream/logs/nginx_access.log;
    client_body_temp_path /app/stream/logs/client_temp;
    proxy_temp_path /app/stream/logs/proxy_temp;
    fastcgi_temp_path /app/stream/logs/fastcgi_temp;
    uwsgi_temp_path /app/stream/logs/uwsgi_temp;
    scgi_temp_path /app/stream/logs/scgi_temp;

    sendfile off;
    tcp_nopush off;
    tcp_nodelay on;
    aio on;
    directio 512;
    keepalive_timeout 65;

    gzip on;
    gzip_types text/plain application/vnd.apple.mpegurl;

    server {
        listen ${PORT};
        server_name _;

        location /hls/ {
            alias /app/stream/hls/;

            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Range" always;
            add_header Accept-Ranges "bytes";

            location ~* \.m3u8$ {
                add_header Cache-Control "no-cache";
                add_header X-Accel-Buffering "no";
                expires off;
            }

            location ~* \.ts$ {
                add_header Cache-Control "max-age=1";
                add_header X-Accel-Buffering "no";
                expires 1s;
            }
        }

        location / {
            return 200 '<!DOCTYPE html><html><head><title>Live Stream</title></head><body style="margin:0;padding:20px;font-family:Arial;"><h1>ðŸŽ¥ Live Stream Server</h1><p><strong>M3U8 Link:</strong> <a href="/hls/playlist.m3u8">https://your-app.koyeb.app/hls/playlist.m3u8</a></p><p><strong>Status:</strong> <span style="color:green">Running âœ“</span></p></body></html>';
            add_header Content-Type text/html;
        }

        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
